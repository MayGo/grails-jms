<html>
     <head>
     	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
     	<title>5. Receiving Messages</title>
     	<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8">
     </head>
	<body class="body">
		<h1><a name="5. Receiving Messages">5. Receiving Messages</a></h1><h2>Consuming Messages</h2><p class="paragraph"/><h3>Service Listeners</h3><p class="paragraph"/>Service listeners are a convenient way to define one handler for JMS messages. The simplest service listener looks like…<p class="paragraph"/><div class="code"><pre>class PersonService &#123;
	<span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;
	def onMessage(msg) &#123;
		// handle message
	&#125;
&#125;</pre></div><p class="paragraph"/>This will register the <code>onMessage</code> method as a listener for the JMS <em class="italic">topic</em> named <code>«application name».person</code> , where «application name» is the <code>app.name</code> key from the <code>application.properties</code> file.<p class="paragraph"/><blockquote class="note">
The return value of onMessage may be sent to a reply queue depending on your configuration. Be careful - due to Groovy's implicit return mechanism, ensure that you return null explicitly if you want nothing to be sent to the reply queue after your onMessage call. For example if you accidentally return a value that cannot be sent to a reply queue, you may have odd side effects like messages never being removed from the queue (due to implicit rollbacks!).
</blockquote><p class="paragraph"/>By default, listener methods receive the payload of the message as extracted by a <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/support/converter/SimpleMessageConverter.html" target="blank">SimpleMessageConverter</a> instance. You can use the “messageConverter” configuration parameter of your listener (details below) to either specify a custom converter or to not use a converter at all and receive the <a href="http://java.sun.com/j2ee/1.4/docs/api/javax/jms/Message.html" target="blank">Message</a> instance instead of the payload.<p class="paragraph"/><h4>Configuration</h4><p class="paragraph"/>The following configuration parameters can be set as static variables on the service class…<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Property Name</th><th>Type</th><th>Default</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">listenerCount</strong></td><td>Number</td><td>1</td><td>The number of concurrent listeners to spawn to listen for messages</td></tr><tr class="table-even"><td><strong class="bold">destination</strong></td><td>String</td><td>«app name».«service name»</td><td>The named destination of the listener</td></tr><tr class="table-odd"><td><strong class="bold">listenerMethod</strong></td><td>String</td><td>onMessage</td><td>The listener method that will handle the messages</td></tr><tr class="table-even"><td><strong class="bold">pubSub</strong></td><td>boolean</td><td>false</td><td>is the destination a topic ( <code>true</code> ) or a queue ( <code>false</code> )</td></tr><tr class="table-odd"><td><strong class="bold">messageSelector</strong></td><td>String</td><td>null</td><td>See the “Message Selector” section of http://java.sun.com/j2ee/1.4/docs/api/javax/jms/Message.html</td></tr><tr class="table-even"><td><strong class="bold">durable</strong></td><td>boolean</td><td>false</td><td>Creates a durable subscription to the topic (redundant if <code>pubSub = false</code> )</td></tr><tr class="table-odd"><td><strong class="bold">clientId</strong></td><td>String</td><td>«app name»</td><td>Provides a client identifier for durable subscriptions</td></tr><tr class="table-even"><td><strong class="bold">connectionFactory</strong></td><td>String</td><td>"jmsConnectionFactory"</td><td>The name of the connection factory bean to use to create a connection to the broker</td></tr><tr class="table-odd"><td><strong class="bold">messageConverter</strong></td><td>String</td><td>""</td><td>a <code>null</code> for no message converter, "" to use a <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/support/converter/SimpleMessageConverter.html," target="blank">SimpleMessageConverter</a> otherwise the name of a bean implementing <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/support/converter/MessageConverter.html" target="blank">MessageConverter</a> (See <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/listener/adapter/MessageListenerAdapter.html" target="blank">discussion on type conversion</a> )</td></tr></table><p class="paragraph"/><h3>Service Method Listeners</h3><p class="paragraph"/>Another avenue is to expose specific methods as message listeners via annotations. This looks like…<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.jms.&#42;<p class="paragraph"/>class PersonService &#123;
	<span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;<p class="paragraph"/>	@Queue
	def addPerson(msg) &#123;<p class="paragraph"/>	&#125;<p class="paragraph"/>	@Subscriber
	def somethingHappened(msg) &#123;<p class="paragraph"/>	&#125;
&#125;</pre></div><p class="paragraph"/>The above configuration binds the <code>personService.addPerson()</code> method to a queue named <code>«app name».person.addPerson</code> and binds the method <code>personService.somethingHappened()</code> as a listener to the topic named <code>somethingHappened</code> .<p class="paragraph"/>Note that you still need to expose the class via ' <code> static exposes = &#91;"jms"] </code> .<p class="paragraph"/><h4><code>Queue Configuration</h4><p class="paragraph"/>The following configuration parameters can be set as annotation parameters…<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Property Name</th><th>Type</th><th>Default</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">name</strong></td><td>String</td><td>«app name».«service name».«method name»</td><td>The destination name for the queue</td></tr><tr class="table-even"><td><strong class="bold">selector</strong></td><td>String</td><td>null</td><td>The message selector to apply (See the “Message Selector” section of http://java.sun.com/j2ee/1.4/docs/api/javax/jms/Message.html)</td></tr><tr class="table-odd"><td><strong class="bold">connectionFactory</strong></td><td>String</td><td>"jmsConnectionFactory"</td><td>The name of the connection factory bean to use to create a connection to the broker</td></tr><tr class="table-even"><td><strong class="bold">messageConverter</strong></td><td>String</td><td>""</td><td>a </code>null@ for no message converter, "" to use a <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/support/converter/SimpleMessageConverter.html," target="blank">SimpleMessageConverter</a> otherwise the name of a bean implementing <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/support/converter/MessageConverter.html" target="blank">MessageConverter</a> (See <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/listener/adapter/MessageListenerAdapter.html" target="blank">discussion on type conversion</a> )</td></tr></table><p class="paragraph"/>Example…<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.jms.&#42;<p class="paragraph"/>class PersonService &#123;
	<span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;<p class="paragraph"/>	@Queue(
		name = <span class="java&#45;quote">"myQueue"</span>,
		selector = <span class="java&#45;quote">"name IS NOT NULL"</span>
	)
	def addPerson(msg) &#123;<p class="paragraph"/>	&#125;
&#125;</pre></div><p class="paragraph"/><h4><code>Subscriber Configuration</h4><p class="paragraph"/>The following configuration parameters can be set as annotation parameters…<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Property Name</th><th>Type</th><th>Default</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">topic</strong></td><td>String</td><td>«method name»</td><td>The name of the topic to subscribe to</td></tr><tr class="table-even"><td><strong class="bold">selector</strong></td><td>String</td><td>null</td><td>The message selector to apply (See the “Message Selector” section of <a href="http://java.sun.com/j2ee/1.4/docs/api/javax/jms/Message.html" target="blank"></a>)</td></tr><tr class="table-odd"><td><strong class="bold">durable</strong></td><td>Boolean</td><td>false</td><td>Whether or not to create a durable subscription</td></tr><tr class="table-even"><td><strong class="bold">connectionFactory</strong></td><td>String</td><td>jmsConnectionFactory</td><td>The name of the connection factory bean to use to create a connection to the broker</td></tr><tr class="table-odd"><td><strong class="bold">messageConverter</strong></td><td>String</td><td>""</td><td>a </code>null@ for no message converter, "" to use a <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/support/converter/SimpleMessageConverter.html," target="blank">SimpleMessageConverter</a> otherwise the name of a bean implementing <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/support/converter/MessageConverter.html" target="blank">MessageConverter</a> (See <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/jms/listener/adapter/MessageListenerAdapter.html" target="blank">discussion on type conversion</a> )</td></tr></table><p class="paragraph"/>Example…<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.jms.&#42;<p class="paragraph"/>class PersonService &#123;
	<span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;<p class="paragraph"/>	@Subscriber(topic = <span class="java&#45;quote">"aTopic"</span>)
	def somethingHappened(msg) &#123;<p class="paragraph"/>	&#125;
&#125;</pre></div>
	</body>
</html>