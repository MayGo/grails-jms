<html>
     <head>
     	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
     	<title>5. Receiving Messages</title>
     	<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8">
     </head>
	<body class="body">
		<h1><a name="5. Receiving Messages">5. Receiving Messages</a></h1><h2><a name="5.1 Service Listeners">5.1 Service Listeners</a></h2><h3>Service Listeners</h3><p class="paragraph"/>Service listeners are a convenient way to define one handler for JMS messages. The simplest service listener looks like…<p class="paragraph"/><div class="code"><pre>class PersonService &#123;
    <span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;
    def onMessage(msg) &#123;
        // handle message
    &#125;
&#125;</pre></div><p class="paragraph"/>This will register the <code>onMessage</code> method as a listener for the JMS <em class="italic">queue</em> named <code>«application name».person</code> , where «application name» is the <code>app.name</code> key from the <code>application.properties</code> file.<p class="paragraph"/>
<h4>Configuration</h4><p class="paragraph"/>The following configuration parameters can be set as static variables on the service class…<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Property Name</th><th>Type</th><th>Default</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">destination</strong></td><td>String</td><td>«app name».«service name»</td><td>The named destination of the listener</td></tr><tr class="table-even"><td><strong class="bold">isTopic</strong></td><td>boolean</td><td>false</td><td>is the destination a topic ( <code>true</code> ) or a queue ( <code>false</code> )</td></tr><tr class="table-odd"><td><strong class="bold">selector</strong></td><td>String</td><td>null</td><td>See the “Message Selector” section of http://java.sun.com/j2ee/1.4/docs/api/javax/jms/Message.html</td></tr><tr class="table-even"><td><strong class="bold">adapter</strong></td><td>String</td><td>"standard"</td><td>The adapter to use for this listener</td></tr><tr class="table-odd"><td><strong class="bold">container</strong></td><td>String</td><td>"standard"</td><td>The container to use for this listener</td></tr></table><p class="paragraph"/><div class="code"><pre>class PersonService &#123;
    <span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;
    <span class="java&#45;keyword">static</span> destination = <span class="java&#45;quote">"somethingHappened"</span>
    <span class="java&#45;keyword">static</span> isTopic = <span class="java&#45;keyword">true</span>
    <span class="java&#45;keyword">static</span> adapter = <span class="java&#45;quote">"custom"</span><p class="paragraph"/>    def onMessage(msg) &#123;
        // handle message
    &#125;
&#125;</pre></div>
<h2><a name="5.2 Service Method Listeners">5.2 Service Method Listeners</a></h2><h3>Service Method Listeners</h3><p class="paragraph"/>Another avenue is to expose specific methods as message listeners via annotations. This looks like…<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.plugin.jms.&#42;<p class="paragraph"/>class PersonService &#123;
	<span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;<p class="paragraph"/>	@Queue
	def addPerson(msg) &#123;<p class="paragraph"/>	&#125;<p class="paragraph"/>	@Subscriber
	def somethingHappened(msg) &#123;<p class="paragraph"/>	&#125;
&#125;</pre></div><p class="paragraph"/>The above configuration binds the <code>personService.addPerson()</code> method to a queue named <code>«app name».person.addPerson</code> and binds the method <code>personService.somethingHappened()</code> as a listener to the topic named <code>somethingHappened</code> .<p class="paragraph"/>Note that you still need to expose the class via ' <code> static exposes = &#91;"jms"] </code> .<p class="paragraph"/><h4>@Queue Configuration</h4><p class="paragraph"/>The following configuration parameters can be set as annotation parameters…<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Property Name</th><th>Type</th><th>Default</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">name</strong></td><td>String</td><td>«app name».«service name».«method name»</td><td>The destination name for the queue</td></tr><tr class="table-even"><td><strong class="bold">selector</strong></td><td>String</td><td>null</td><td>The message selector to apply (See the “Message Selector” section of http://java.sun.com/j2ee/1.4/docs/api/javax/jms/Message.html)</td></tr><tr class="table-odd"><td><strong class="bold">adapter</strong></td><td>String</td><td>"standard"</td><td>The adapter to use for this listener</td></tr><tr class="table-even"><td><strong class="bold">container</strong></td><td>String</td><td>"standard"</td><td>The container to use for this listener</td></tr></table><p class="paragraph"/>Example…<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.jms.&#42;<p class="paragraph"/>class PersonService &#123;
	<span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;<p class="paragraph"/>	@Queue(
		name = <span class="java&#45;quote">"myQueue"</span>,
		selector = <span class="java&#45;quote">"name IS NOT NULL"</span>
	)
	def addPerson(msg) &#123;<p class="paragraph"/>	&#125;
&#125;</pre></div><p class="paragraph"/><h4>@Subscriber Configuration</h4><p class="paragraph"/>The following configuration parameters can be set as annotation parameters…<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Property Name</th><th>Type</th><th>Default</th><th>Description</th></tr><tr class="table-odd"><td><strong class="bold">topic</strong></td><td>String</td><td>«method name»</td><td>The name of the topic to subscribe to</td></tr><tr class="table-even"><td><strong class="bold">selector</strong></td><td>String</td><td>null</td><td>The message selector to apply (See the “Message Selector” section of <a href="http://java.sun.com/j2ee/1.4/docs/api/javax/jms/Message.html" target="blank"></a>)</td></tr><tr class="table-odd"><td><strong class="bold">adapter</strong></td><td>String</td><td>"standard"</td><td>The adapter to use for this listener</td></tr><tr class="table-even"><td><strong class="bold">container</strong></td><td>String</td><td>"standard"</td><td>The container to use for this listener</td></tr></table><p class="paragraph"/>Example…<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.jms.&#42;<p class="paragraph"/>class PersonService &#123;
	<span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;<p class="paragraph"/>	@Subscriber(topic = <span class="java&#45;quote">"aTopic"</span>)
	def somethingHappened(msg) &#123;<p class="paragraph"/>	&#125;
&#125;</pre></div><h2><a name="5.3 Listener Return Values">5.3 Listener Return Values</a></h2>Spring's <a href="http://static.springsource.org/spring/docs/3.0.x/api/org/springframework/jms/listener/adapter/MessageListenerAdapter.html" target="blank">MessageListenerAdapter</a> adds some special handling of listener method return values.<p class="paragraph"/>From MessageListenerAdapter's JavaDoc: "If a target listener method returns a non-null object (typically of a message content type such as String or byte array), it will get wrapped in a JMS Message and sent to the response destination (either the JMS "reply-to" destination or a specified default destination)."<p class="paragraph"/>Be careful with Groovy's implicit return mechanism; ensure that you return null explicitly if you want nothing to be sent to the reply destination. If you accidentally return a value that cannot be sent to the reply destination, you may have odd side effects like messages never being removed from the queue (due to implicit rollbacks!).
<h2><a name="5.4 Using Other Containers Or Adapters">5.4 Using Other Containers Or Adapters</a></h2>Here is an example of using a container and adapter other than standard.<p class="paragraph"/><h5>resources.groovy</h5><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory
<span class="java&#45;keyword">import</span> org.springframework.jms.connection.SingleConnectionFactory<p class="paragraph"/>beans = &#123;
    // used by the standard template by convention
    jmsConnectionFactory(SingleConnectionFactory) &#123;
        targetConnectionFactory = &#123; ActiveMQConnectionFactory cf &#45;&#62;
            brokerURL = 'vm://localhost'
        &#125;
    &#125;<p class="paragraph"/>    otherJmsConnectionFactory(SingleConnectionFactory) &#123;
        targetConnectionFactory = &#123; ActiveMQConnectionFactory cf &#45;&#62;
            brokerURL = // &#8230; something <span class="java&#45;keyword">else</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><h5>Config.groovy </h5><p class="paragraph"/><div class="code"><pre>jms &#123;
    containers &#123;
        other &#123;
            meta &#123;
                parentBean = 'standardJmsListenerContainer'
            &#125;
            concurrentConsumers = 5
            connectionFactoryBean = <span class="java&#45;quote">"otherJmsConnectionFactory"</span>
        &#125;
    &#125;
    adapters &#123; 
        other &#123;
            meta &#123;
                parentBean = 'standardJmsListenerAdapter'
            &#125;
            messageConverter = <span class="java&#45;keyword">null</span> // <span class="java&#45;keyword">do</span> no message conversion
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><h5>Sending messages</h5><p class="paragraph"/><div class="code"><pre>class ListeningService &#123;
    <span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;
    <span class="java&#45;keyword">static</span> adapter = <span class="java&#45;quote">"other"</span>
    <span class="java&#45;keyword">static</span> container = <span class="java&#45;quote">"other"</span><p class="paragraph"/>    def onMessage(msg) &#123;
        // handle message
    &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.plugin.jms.&#42;<p class="paragraph"/>class ListeningService &#123;
    <span class="java&#45;keyword">static</span> exposes = &#91;<span class="java&#45;quote">"jms"</span>&#93;<p class="paragraph"/>    @Queue(adapter = <span class="java&#45;quote">"other"</span>, container = <span class="java&#45;quote">"other"</span>)
    def receive(msg) &#123;
        // handle message
    &#125;
&#125;</pre></div>

	</body>
</html>